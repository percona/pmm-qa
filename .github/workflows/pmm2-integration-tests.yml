---
name: pmm2-integration-tests

on:
  # run with default inputs
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - main
  pull_request:

  workflow_dispatch:
    inputs:
      pmm_ui_tests_branch:
        description: 'Target branch for pmm-ui-tests repository'
        default: 'main'
        required: true
      pmm_qa_branch:
        description: 'Target branch for pmm-qa repository'
        default: 'main'
        required: true
      integration_setup:
        description: 'Add flag to test selected integration setup'
        default: '--setup-pmm-pgsm-integration'
        required: true
      pmm_server_version:
        description: 'Provide version of pmm server'
        default: 'dev-latest'
        required: true
      pgsql_version:
        description: 'Provide version of pgsql'
        default: '15'
        required: true

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      SHA: ${{ github.event.inputs.sha || 'null' }}
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true

      UI_TESTS_BRANCH: ${{ github.event.inputs.pmm_ui_tests_branch }}
      QA_TESTS_BRANCH: ${{ github.event.inputs.pmm_qa_branch }}
      INTEGRATION_SETUP: ${{ github.event.inputs.integration_setup }}
      PMM_SERVER_VERSION: ${{ github.event.inputs.pmm_server_version }}

      PGSQL_VERSION: ${{ github.event.inputs.pgsql_version || 15 }}

    steps:
      - name: Tests of pmm server version ${{ github.event.inputs.pmm_server_version }} for integration flag ${{ github.event.inputs.integration_setup }}
        if: ${{ github.event_name == 'workflow_dispatch' && env.SHA != 'null' }}
        uses: percona-platform/github-status-action@v1
        with:
          context: 'pmm2-ui-tests'
          description: 'Tests execution has been started'
          state: 'pending'
          repository: ${{ github.event.inputs.repo }}
          target_url: 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          sha: ${{ env.SHA }}

      - name: Install NodeJS v16
        uses: percona-platform/setup-node@v2
        with:
          node-version: 16.14.1

      - name: Checkout UI tests
        uses: percona-platform/checkout@v2
        with:
          ref: ${{ env.UI_TESTS_BRANCH }}
          repository: percona/pmm-ui-tests
          path: ./pmm-ui-tests

      - name: Checkout pmm-qa Repo
        uses: percona-platform/checkout@v2
        with:
          # token: ${{ secrets.ROBOT_TOKEN }}
          repository: percona/pmm-qa
          path: ./pmm-qa
          ref: ${{ env.QA_TESTS_BRANCH }}

      - name: Start PMM-Sever
        run: |
          docker network create pmm-integration-network
          docker run -d --restart always -e PERCONA_TEST_PLATFORM_ADDRESS=https://check-dev.percona.com:443 --network="pmm-integration-network" --publish 80:80 --publish 443:443 --name pmm-integration-server perconalab/pmm-server:${{ env.PMM_SERVER_VERSION }}

      - name: Create env file
        run: |
          cd pmm-qa/pmm-integration/
          touch .env
          echo CI=true >> .env

      - name: Setup Client for PMM-Server
        run: |
          wget https://repo.percona.com/apt/percona-release_latest.generic_all.deb
          sudo dpkg -i percona-release_latest.generic_all.deb
          sudo apt update
          sudo apt install -y pmm2-client
          sudo pmm-admin config --server-url=https://admin:admin@127.0.0.1:443 --server-insecure-tls

      - name: Setup Databases for PMM-Server
        run: |
          cd pmm-qa/pmm-integration/
          sudo npm install
          sudo npx ts-node ./integration-setup.ts --pgsql-version=${{ env.PGSQL_VERSION }} ${{ env.INTEGRATION_SETUP }}
        shell: bash

      - name: Execute Integration Tests
        id: pmm-ui-tests-all
        run: |
          sudo docker ps -a
          sudo docker exec ps_pmm_8.0 pmm-admin list
          printenv INTEGRATION_FLAG
          cd ./pmm-ui-tests
          npm install
          ./node_modules/.bin/codeceptjs run-multiple parallel --debug --steps --reporter mochawesome -c pr.codecept.js  --grep '${{ env.INTEGRATION_FLAG }}'

      - name: Generating the report
        if: ${{ always() && (steps.pmm-ui-tests-all.outcome != 'skipped' || steps.pmm-ui-tests-tagged.outcome != 'skipped' ) }}
        run: |
          cd ./pmm-ui-tests
          npx mochawesome-merge tests/output/*/*.json > tests/output/output.json

      - name: Create the report
        uses: phoenix-actions/test-reporting@v10
        if: success() || failure()
        with:
          token: ${{ secrets.ROBOT_TOKEN }}
          name: Integration Tests
          path: pmm-ui-tests/tests/output/output.json
          reporter: mocha-json    

      - name: Attaching the report
        if: ${{ always() && (steps.pmm-ui-tests-all.outcome != 'skipped' || steps.pmm-ui-tests-tagged.outcome != 'skipped' ) }}
        uses: percona-platform/upload-artifact@v2
        with:
          name: pmm-ui-tests-report
          path: pmm-ui-tests/tests/output
